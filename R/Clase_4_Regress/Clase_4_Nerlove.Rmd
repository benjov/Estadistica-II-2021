---
title: "Regresi贸n Lineal"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

### Dependencies
```{r, warning = FALSE, message = FALSE}

#tinytex::install_tinytex()
#installed.packages('foreign')
#install.packages("ggplot2")
#install.packages("dplyr")
#install.packages("plotly")
#install.packages('car')

library(tidyverse)
library(knitr)
library(foreign)
library(ggplot2)
library(dplyr)
library(plotly)
library(car)

```

# Aplicaci贸n del M茅todo de MCO: Retornos a Escala en la Industria El茅ctrica

Esta aplicaci贸n tiene su origen en el trabajo de Nerlove (1963). Este es un estudio cl谩sico de los retornos a escala en una industria regulada. Nerlove ofreci贸 una buena descripci贸n de la industria el茅ctrica, dicha descripci贸n es v谩lida para el momento en que se escribi贸:

* Los oferentes/generadores de electricidad son monopolios locales privados.
* Las tarifas o precios minoristas de la el茅ctricidad son establecidos por un ente regulador.
* Los precios de los factores productivos est谩n dados y no son modificables por las empresas en el corto plazo, ya que existen diversos contratos de largo plazo (por ejemplo, los contratos laborales) -- i.e., todas las empresas son tomadoras de precios.

Respecto de los datos, estos consisten en 145 empresas ubicadas en 44 estados en EUA en el a帽o 1955, ya que son para los 煤nicos estados para los que existe informaci贸n. El estudio utiliz贸 informaci贸n de aproximadamente el 80% de la electricidad producida.

Visto por la forma de producci贸n, Nerlove identic贸 que exist铆an 3 m茅todos de producci贸n de electricidad:

* Motores de conbusti贸n interna.
* Hidroel茅ctricas.
* Termoel茅ctricas.

Al respecto, Nerlove muestra que en los 50's cerca del 70% de la electricidad era producida por las empresas termoel茅ctricas. El combustible pincipal empleado en dichas termoel茅ctricas era carb贸n (66.4%), seguido de petr贸leo (14.5%) y gasolina (19.1%).

##  Variables

Variables consideradas en el an谩lisis: costos totales, precios de los factores (salarios, precios de combustibles, renta o precio del capital), y el producto. Aunque las empresas son due帽as del capital, en el modelo se supone que dichas empresas se comportan como si estas pagaran una renta de capital, por lo que se imputa un precio por el costo de capital.

No obstante, para mayores detalles refierase al documento original de Nerlove, donde se describe con mayor detalle la forma en que fue constru铆da la base de datos. Los datos de producci贸n, combustibles y costos laborales fueron obtenidos de la Federal Power Commision (1956).

## Motivaci贸n econ贸mica

La motivaci贸n para el anal铆sis es que mediante un enfoque econom茅trico se puede construir una curva de costo promedio (AC, por sus siglas en ingl茅s) para cada empresa, misma que es diferente de la promedio de la industria. Esto es, la empresas enfrentan diferentes precios por los factores productivos y por lo tanto diferentes costos totales, medios y marginales.

Para enfocarnos en la conexi贸n entre la eficiencia de producci贸n y el producto, asumimos que todas las empresas enfrentan mas o menos los mismos precios de los factores, y la 煤nica raz贸n por la que las curvas de costo medio (AC) y de costo marginal (MC) difieren entre las empresas es la diferencia en la eficiencia productiva. Las curvas de AC y de MC tienen pendiente positiva para reflejar retornos a escala decrecientes.

Si vemos la siguiente Figura, las curvas de AC y MC de la empresa A estan a la izquierda de las de la empresa B porque la empresa A es menos eficiente que B. Esto es derivado de que la industria es competida, ambas empresas enfrentan el mismo precio . Dado que la cantidad est谩 determinada por la intersecci贸n de MC y el precio de mercado, las combinaciones de cantidad / producto y el AC para las dos empresas e ilustra en la Figura.

```{r, echo = FALSE}
# Small fig.width
include_graphics('Hayashi_p62.png')

```

De esta forma, la curva que resulta de conectar los puntos A y B puede tener una pendiente negativa, dando la impresi贸n de un escenario de rendimientos crecientes a escala en la industria, ya que la agregaci贸n de todos los puntos de las empresas individuales conformaran la curva de costos promedio de la industria.

La parametrizaci贸n de la funci贸n de costos parte de una funci贸n de producci贸n del tipo Cobb - Douglas:
$$Q_i = A_i x^{\alpha_1}_{i1} x^{\alpha_2}_{i2} x^{\alpha_3}_{i3}$$

Donde $Q_i$ es la producci贸n de la empresa $i$, $x_{i1}$ es el insumo de trabajo para la empresa $i$, $x_{i2}$ es el insumo capital para la empresa $i$, y $x_{i3}$ es el insumo de combustible para la empresa $i$. El t茅rmino $A_i$ captura las diferencias no observables en la eficiencia de producci贸n (este t茅rmino tambi茅n es conocido como el de heterogenidad de las empresas). 

Asimismo, la suma de los param茅tros: $\alpha_1 + \alpha_2 + \alpha_3 = r$ indica el grado de retornos a escala. Dado esto 煤ltimo, asumiremos que el grado de retornos a escala es constante (esto no significa que existen retornos a escala constantes, ya que para ello se deber铆a cumplir que $r = 1$). Adicionalmente, en el modelo se supone que dada la naturaleza de propiedad de las empresas generadoras, el problema que cada una ellas enfrenta es uno de minimizaci贸n de costos (v茅ase Nerlove (1963) para una discusi贸n sobre las restricciones relacionadas con este supuesto).

En este sentido, el problema que cada empresa enfrenta es el de minimizar sus costos de producci贸n, sujeto a la cantidad producida, es decir:
$$\min_{x_{i1}, \ldots, x_{iK}} \sum_{k = 1}^{K} p_{ik}x_{ik}$$
s.a.
$$Q_i = f(x_{i1}, \ldots, x_{iK}, A_i)$$

Resolviendo el problema anterior (ver notas de clase para detalles):
$$ln(C_i) = \mu_i +  \frac{1}{r} ln(Q_i) + \frac{\alpha_1}{r} ln(p_{i1}) + \frac{\alpha_2}{r} ln(p_{i2}) + \frac{\alpha_3}{r} ln(p_{i3})$$

Donde $\mu_i = ln \left[ r \left( A_i \alpha^{\alpha_1}_{1} \alpha^{\alpha_2}_{2} \alpha^{\alpha_3}_{3} \right)^{-1/r} \right]$. 

La ecuaci贸n es conocida como una ecuaci贸n log-lineal, de la cual se puede interpretar a sus pendientes como elasticidades. Es decir, el cambio porcentual en el costo total cuando se incremnta en 1% el precio de cualquiera de los factores. 

Si definimos a $\mu = \mathbb{E} [\mu_i]$ y a $\varepsilon_i = \mu_i - \mu$, de tal forma que $\mathbb{E} [\varepsilon_i] = 0$. De esta forma $\varepsilon_i$ se puede interpretar como la eficiencia productiva de las empresas. Considerando lo anterior plateamos la expresi贸n:
$$ln(C_i) = \beta_1 +  \beta_2 ln(Q_i) + \beta_3 ln(p_{i1}) + \beta_4 ln(p_{i2}) + \beta_5 ln(p_{i3}) + \varepsilon_i$$

Donde:
$$\beta_1 = \mu$$

$$\beta_2 = \frac{1}{r}$$

$$\beta_3 = \frac{\alpha_1}{r}$$

$$\beta_4 = \frac{\alpha_2}{r}$$

$$\beta_5 = \frac{\alpha_3}{r}$$

Por lo tannto:
$$\beta_3 + \beta_4 + \beta_5 = 1$$

De esta forma podemos decir que $y_i = ln(C_i)$ y que:
$$\mathbf{X}'_i = [\mathbb{1}, ln(Q_i), ln(p_{i1}), ln(p_{i2}), ln(p_{i3})]$$

Esta funci贸n tambi茅n es conocida como una funci贸n trans-log o trans-logar铆tmica, de la cual podemos recuperar una forma estimada de la funci贸n de costos original:

```{r, echo = FALSE}
# Small fig.width
include_graphics('Nerlove.png')

```

# Plan de la clase:
### Regresi贸n lineal
### Media condicional descrita por:
$$ln(C_i) = \beta_1 +  \beta_2 ln(Output_i) + \beta_3 ln(plabor_{i1}) + \beta_4 ln(pfuel_{i2}) + \beta_5 ln(pkap_{i3}) + \varepsilon_i$$

### Metadatos: La base de datos contiene 145 observaciones  de las siguientes variables:
**Datos de Demanda de Gasolina:**
* **totcost:** costs in 1970, MM USD

* **output:** output billion KwH
* **plabor:** price of labor
* **pfuel:** price of fuel
* **pkap:** price of capital

### Read Stata file
```{r}

dataframe <- read.dta("nerlove63.dta")

```
### Preview 
```{r, echo = FALSE}

names(dataframe)

dataframe %>% head()

```


### Estad铆sticas descriptivas
```{r, echo = FALSE}

summary(dataframe)

```

### Nuevas variables:
```{r}

dataframe$Ltotcost = log(dataframe$totcost)
dataframe$Loutput = log(dataframe$output)
dataframe$Lplabor = log(dataframe$plabor)
dataframe$Lpfuel = log(dataframe$pfuel)
dataframe$Lpkap = log(dataframe$pkap)
dataframe$avgcost = dataframe$totcost/dataframe$output

dataframe %>% head()

```

### Otras Estadisticas Descriptivas
```{r, echo = FALSE}

fig <- plot_ly(alpha = 0.6)
#fig <- fig %>% add_histogram(x = dataframe$plabor, name = 'plabor')
fig <- fig %>% add_histogram(x = ~dataframe$pkap, name = 'pkap')
#fig <- fig %>% layout(barmode = "overlay")

fig

```

### Density plots
```{r, echo = FALSE}

p <- ggplot(dataframe, aes(totcost)) + 
  geom_density( fill="#69b3a2", color="#e9ecef", alpha=0.8 ) + 
  ggtitle("Gr谩fica de densidad") 

fig <- ggplotly(p)

fig

```

### Regresion:

Estimadores:

$$\hat{\boldsymbol \beta} = (\mathbf{X'X})^{-1}\mathbf{X'Y}$$

La especificaci贸n m谩s com煤n de la prueba de hip贸tesis en el an谩lisis de regresi贸n es:
$$H_0: \beta_k = 0$$
$$H_a: \beta_k \neq 0$$

Lo que en t茅rminos de una prueba $t$ es la siguiente:
$$t = \frac{\hat{\beta}_k - 0}{\sqrt{\hat{\sigma}^2 (\mathbf{X}'\mathbf{X})^{-1}_{kk}}} \sim t_{n - k}$$

En el caso que nos ocupa queremos probar si la suma de los coeficientes asociados los factores productivos es 1, es decir, la funci贸n de costos exibe rendimientos constantes a escala:
$$H_0: \beta_3 + \beta_4 + \beta_5 = 1$$
$$H_1: \beta_3 + \beta_4 + \beta_5 \neq 1$$

Existen dos alternativas para probar la hip贸tesis. Partamos de que:
La matriz $\mathbf{R}$ y vector $\mathbf{r}$:
$$\mathbf{R} = \left[ 
            \begin{array}{c c c c c}
                0 & 0 & 1 & 1 & 1 
            \end{array}
            \right]$$

$$\mathbf{r} = 1$$

$$t = \frac{\beta_3 + \beta_4 + \beta_5 - 1}{\sqrt{\hat{\sigma}^2 \mathbf{R} (\mathbf{X}'\mathbf{X})^{-1} \mathbf{R}'}} \sim t_{n - k}$$

### Scatter plots
```{r, echo = FALSE}

fig <- plot_ly(data = dataframe, x = ~output, y = ~avgcost, 
               marker = list(size = 8, color = 'darkred'))

fig <- fig %>% layout(title = 'Costo medio y producto')

fig

```


# Regresi贸n lineal
```{r, echo = FALSE}

#Create the linear regression
Reg_01 = lm(Ltotcost ~ Loutput + Lplabor + Lpfuel + Lpkap, data = dataframe) 

summary(Reg_01)

```

# Regresi贸n lineal - Linear Hypothesis

$$H_0: \beta_3 + \beta_4 + \beta_5 = 1$$
$$H_1: \beta_3 + \beta_4 + \beta_5 \neq 1$$

```{r, echo = FALSE}

hypothesis <- "Lplabor + Lpfuel + Lpkap = 1"

test <- linearHypothesis(Reg_01, hypothesis)

test

```


